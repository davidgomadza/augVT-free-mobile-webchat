<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AugVT â€” Free Mobile Phone (Enhanced Interactive Demo)</title>
  <style>
    :root {
      --bg: #071021;
      --card: #0e1724;
      --accent: #00e6a8;
      --muted: #9fb0bf;
      --danger: #ff4757;
      --success: #2ed573;
      --warning: #ffa502;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', system-ui, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(180deg, #041026 0%, #06152a 100%);
      color: #eaf6f0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      gap: 20px;
    }
    
    header {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent), #00b894);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
    }
    
    h1 {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent), #00b894);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }
    
    .subtitle {
      color: var(--muted);
      font-size: 14px;
      max-width: 500px;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
    }
    
    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    
    .panel {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .contacts-panel {
      display: flex;
      flex-direction: column;
      height: 600px;
    }
    
    .contacts-header {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .contacts-header input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.2);
      color: white;
      font-size: 14px;
    }
    
    .contacts-header button {
      padding: 10px 15px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #012;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .contacts-header button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 230, 168, 0.3);
    }
    
    .contacts-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .contact {
      padding: 12px 15px;
      border-radius: 10px;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.05);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .contact:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .contact.active {
      background: rgba(0, 230, 168, 0.1);
      border-color: rgba(0, 230, 168, 0.3);
    }
    
    .contact-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    .contact-info {
      flex: 1;
    }
    
    .contact-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .contact-token {
      font-size: 12px;
      color: var(--muted);
    }
    
    .token-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .token-display {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .token-display input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.2);
      color: white;
      font-family: monospace;
      font-size: 14px;
    }
    
    .chat-panel {
      display: flex;
      flex-direction: column;
      height: 600px;
    }
    
    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .current-contact {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .contact-status {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }
    
    .chat-controls {
      display: flex;
      gap: 10px;
    }
    
    .chat-controls button {
      padding: 8px 15px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .btn-primary {
      background: var(--accent);
      color: #012;
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .chat-controls button:hover {
      transform: translateY(-2px);
    }
    
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .message {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message-out {
      align-self: flex-end;
      background: linear-gradient(90deg, #005f4d, #008c6a);
      border-bottom-right-radius: 5px;
    }
    
    .message-in {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.08);
      border-bottom-left-radius: 5px;
    }
    
    .message-text {
      font-size: 15px;
      line-height: 1.4;
    }
    
    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 5px;
      text-align: right;
    }
    
    .message-in .message-time {
      text-align: left;
    }
    
    .composer {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .composer input {
      flex: 1;
      padding: 12px 15px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.2);
      color: white;
      font-size: 15px;
    }
    
    .composer button {
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #012;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .composer button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 230, 168, 0.3);
    }
    
    .webrtc-panel {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .webrtc-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .webrtc-instructions {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 15px;
    }
    
    .webrtc-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .webrtc-box {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .webrtc-box textarea {
      height: 100px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.2);
      color: white;
      font-family: monospace;
      font-size: 13px;
      resize: vertical;
    }
    
    .webrct-buttons {
      display: flex;
      gap: 10px;
    }
    
    .webrct-buttons button {
      flex: 1;
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .connection-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.2);
      font-size: 13px;
    }
    
    .status-connected {
      color: var(--success);
    }
    
    .status-disconnected {
      color: var(--muted);
    }
    
    .status-connecting {
      color: var(--warning);
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .file-drop-area {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      margin-top: 15px;
      transition: all 0.3s;
    }
    
    .file-drop-area.active {
      border-color: var(--accent);
      background: rgba(0, 230, 168, 0.05);
    }
    
    .preset-contacts {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .preset-contact {
      padding: 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .preset-contact:hover {
      background: rgba(255, 255, 255, 0.1);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="logo">
        <div class="logo-icon">A</div>
        <div>
          <h1>AugVT â€” Free Mobile Webchat</h1>
          <div class="subtitle">Enhanced peer-to-peer communication with WebRTC technology. No servers required.</div>
        </div>
      </div>
      <div class="connection-status status-disconnected" id="globalStatus">
        Status: Disconnected
      </div>
    </header>
    
    <div class="main-content">
      <aside class="panel contacts-panel">
        <div class="contacts-header">
          <input id="contactName" type="text" placeholder="New contact name" />
          <button id="addContact">Add Contact</button>
        </div>
        
        <div class="preset-contacts">
          <div class="preset-contact" data-name="Donald Trump" data-token="CT-xw4qiy">
            <div class="contact-avatar">DT</div>
            <div class="contact-name">Donald Trump</div>
            <div class="contact-token">CT-xw4qiy</div>
          </div>
          <div class="preset-contact" data-name="Elon Musk" data-token="CT-musk2024">
            <div class="contact-avatar">EM</div>
            <div class="contact-name">Elon Musk</div>
            <div class="contact-token">CT-musk2024</div>
          </div>
          <div class="preset-contact" data-name="David Gomadza" data-token="CT-gomadza">
            <div class="contact-avatar">DG</div>
            <div class="contact-name">David Gomadza</div>
            <div class="contact-token">CT-gomadza</div>
          </div>
        </div>
        
        <div class="contacts-list" id="contacts"></div>
        
        <div class="token-section">
          <div style="font-size: 14px; margin-bottom: 8px;">Your Contact Token:</div>
          <div class="token-display">
            <input id="myToken" type="text" readonly />
            <button id="regenToken">New</button>
          </div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 8px;">
            Share this token with others to connect
          </div>
        </div>
      </aside>
      
      <main class="panel chat-panel">
        <div class="chat-header">
          <div class="current-contact">
            <div class="contact-avatar" id="currentAvatar">?</div>
            <div>
              <div style="font-weight: 600;" id="currentContactName">Select a contact</div>
              <div class="contact-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="currentContactStatus">Offline</span>
              </div>
            </div>
          </div>
          
          <div class="chat-controls">
            <button class="btn-primary" id="startCall">Call</button>
            <button class="btn-secondary" id="simulateIncoming">Simulate</button>
            <button class="btn-danger" id="endCall" disabled>End</button>
          </div>
        </div>
        
        <div class="messages-container" id="messages">
          <div class="message message-in">
            <div class="message-text">Welcome to AugVT! Select a contact to start chatting.</div>
            <div class="message-time">Just now</div>
          </div>
        </div>
        
        <div class="composer">
          <input id="msgInput" type="text" placeholder="Type a message..." disabled />
          <button id="sendBtn" disabled>Send</button>
        </div>
        
        <div class="file-drop-area" id="fileDropArea">
          Drag & drop files here to share (WebRTC required)
        </div>
        
        <div class="webrtc-panel">
          <div class="webrtc-title">WebRTC Connection</div>
          <div class="webrtc-instructions">
            1. Create Offer â†’ Copy â†’ Send to peer. 2. Paste their Answer â†’ Connect.
          </div>
          
          <div class="webrtc-controls">
            <div class="webrtc-box">
              <textarea id="offer" placeholder="Offer will appear here"></textarea>
              <div class="webrct-buttons">
                <button class="btn-primary" id="createOffer">Create Offer</button>
                <button class="btn-secondary" id="copyOffer">Copy</button>
              </div>
            </div>
            
            <div class="webrtc-box">
              <textarea id="answer" placeholder="Paste offer here then create answer"></textarea>
              <div class="webrct-buttons">
                <button class="btn-primary" id="createAnswer">Create Answer</button>
                <button class="btn-secondary" id="pasteAnswer">Paste Answer</button>
              </div>
            </div>
          </div>
          
          <div class="connection-status status-disconnected" id="connectionStatus">
            WebRTC: Not connected â€¢ Data channel: Closed
          </div>
        </div>
      </main>
    </div>
  </div>
  
  <div id="toast" class="toast"></div>
  
  <script>
    // Enhanced AugVT interactive artifact
    const contactsEl = document.getElementById('contacts');
    const messagesEl = document.getElementById('messages');
    const myTokenInput = document.getElementById('myToken');
    const currentContactNameEl = document.getElementById('currentContactName');
    const currentContactStatusEl = document.getElementById('currentContactStatus');
    const statusDotEl = document.getElementById('statusDot');
    const globalStatusEl = document.getElementById('globalStatus');
    const connectionStatusEl = document.getElementById('connectionStatus');
    const fileDropArea = document.getElementById('fileDropArea');
    
    // Initialize state
    let state = JSON.parse(localStorage.getItem('augvt_state') || '{}');
    if (!state.contacts) state.contacts = [];
    if (!state.chats) state.chats = {};
    if (!state.token) state.token = generateToken();
    
    // Preset contacts
    const presetContacts = [
      { id: 'donald-trump', name: 'Donald Trump', token: 'CT-xw4qiy', avatar: 'DT' },
      { id: 'elon-musk', name: 'Elon Musk', token: 'CT-musk2024', avatar: 'EM' },
      { id: 'david-gomadza', name: 'David Gomadza', token: 'CT-gomadza', avatar: 'DG' }
    ];
    
    // Add preset contacts if not already in state
    presetContacts.forEach(preset => {
      if (!state.contacts.find(c => c.id === preset.id)) {
        state.contacts.push(preset);
      }
    });
    
    saveState();
    
    // Utility functions
    function generateToken() {
      return 'AUGVT-' + Math.random().toString(36).slice(2, 10).toUpperCase();
    }
    
    function saveState() {
      localStorage.setItem('augvt_state', JSON.stringify(state));
      renderContacts();
      myTokenInput.value = state.token;
    }
    
    function showToast(msg, timeout = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, timeout);
    }
    
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    // Render contacts list
    function renderContacts() {
      contactsEl.innerHTML = '';
      state.contacts.forEach(contact => {
        const el = document.createElement('div');
        el.className = 'contact';
        el.innerHTML = `
          <div class="contact-avatar">${contact.avatar || contact.name.charAt(0)}</div>
          <div class="contact-info">
            <div class="contact-name">${contact.name}</div>
            <div class="contact-token">${contact.token}</div>
          </div>
        `;
        
        el.addEventListener('click', () => {
          openChat(contact.id);
          document.querySelectorAll('.contact').forEach(n => n.classList.remove('active'));
          el.classList.add('active');
        });
        
        contactsEl.appendChild(el);
      });
    }
    
    // Open chat with a contact
    function openChat(contactId) {
      const contact = state.contacts.find(c => c.id === contactId);
      if (!contact) return;
      
      currentContactNameEl.textContent = contact.name;
      document.getElementById('currentAvatar').textContent = contact.avatar || contact.name.charAt(0);
      currentContactStatusEl.textContent = 'Online';
      statusDotEl.style.background = 'var(--success)';
      
      window.currentChat = contactId;
      renderMessages(contactId);
      
      // Enable message input
      document.getElementById('msgInput').disabled = false;
      document.getElementById('sendBtn').disabled = false;
    }
    
    // Render messages for a chat
    function renderMessages(contactId) {
      messagesEl.innerHTML = '';
      const chat = state.chats[contactId] || [];
      
      if (chat.length === 0) {
        const welcomeMsg = document.createElement('div');
        welcomeMsg.className = 'message message-in';
        welcomeMsg.innerHTML = `
          <div class="message-text">Start a conversation with ${state.contacts.find(c => c.id === contactId).name}</div>
          <div class="message-time">${formatTime(Date.now())}</div>
        `;
        messagesEl.appendChild(welcomeMsg);
      } else {
        chat.forEach(msg => {
          const el = document.createElement('div');
          el.className = `message ${msg.out ? 'message-out' : 'message-in'}`;
          el.innerHTML = `
            <div class="message-text">${msg.text}</div>
            <div class="message-time">${formatTime(msg.time)}</div>
          `;
          messagesEl.appendChild(el);
        });
      }
      
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    
    // Append a message to a chat
    function appendMessage(contactId, text, out = false) {
      if (!state.chats[contactId]) state.chats[contactId] = [];
      state.chats[contactId].push({
        text,
        out,
        time: Date.now()
      });
      saveState();
      renderMessages(contactId);
    }
    
    // WebRTC variables
    let pc = null;
    let dataChannel = null;
    let localStream = null;
    
    // Set up data channel event handlers
    function setupDataChannel() {
      if (!dataChannel) return;
      
      dataChannel.onopen = () => {
        connectionStatusEl.textContent = 'WebRTC: Connected â€¢ Data channel: Open';
        connectionStatusEl.className = 'connection-status status-connected';
        globalStatusEl.textContent = 'Status: Connected';
        globalStatusEl.className = 'connection-status status-connected';
        showToast('Data channel connected!');
      };
      
      dataChannel.onclose = () => {
        connectionStatusEl.textContent = 'WebRTC: Not connected â€¢ Data channel: Closed';
        connectionStatusEl.className = 'connection-status status-disconnected';
        globalStatusEl.textContent = 'Status: Disconnected';
        globalStatusEl.className = 'connection-status status-disconnected';
      };
      
      dataChannel.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          if (data.type === 'chat') {
            const contactId = window.currentChat || 'peer';
            appendMessage(contactId, data.text, false);
          }
        } catch (err) {
          console.log('Received:', e.data);
        }
      };
    }
    
    // Create a peer connection
    async function createPeer(isCaller) {
      pc = new RTCPeerConnection();
      
      pc.onconnectionstatechange = () => {
        const status = pc.connectionState;
        if (status === 'connected') {
          connectionStatusEl.textContent = 'WebRTC: Connected â€¢ Data channel: ' + 
            (dataChannel ? dataChannel.readyState : 'Unknown');
        } else {
          connectionStatusEl.textContent = `WebRTC: ${status} â€¢ Data channel: ` + 
            (dataChannel ? dataChannel.readyState : 'Unknown');
        }
      };
      
      pc.ondatachannel = (e) => {
        dataChannel = e.channel;
        setupDataChannel();
      };
      
      // Add local audio track if available
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      } catch (err) {
        console.warn('Microphone access denied or not available', err);
      }
      
      return pc;
    }
    
    // Event listeners
    document.getElementById('addContact').addEventListener('click', () => {
      const name = document.getElementById('contactName').value.trim();
      if (!name) return;
      
      const id = 'C-' + Math.random().toString(36).slice(2, 8);
      const avatar = name.split(' ').map(n => n.charAt(0)).join('').toUpperCase();
      
      state.contacts.push({
        id,
        name,
        token: 'CT-' + Math.random().toString(36).slice(2, 8).toUpperCase(),
        avatar
      });
      
      saveState();
      document.getElementById('contactName').value = '';
      showToast('Contact added successfully');
    });
    
    document.getElementById('regenToken').addEventListener('click', () => {
      state.token = generateToken();
      saveState();
      showToast('Token regenerated');
    });
    
    document.getElementById('sendBtn').addEventListener('click', () => {
      const text = document.getElementById('msgInput').value.trim();
      if (!text) return;
      
      if (!window.currentChat) {
        showToast('Please select a contact first');
        return;
      }
      
      appendMessage(window.currentChat, text, true);
      document.getElementById('msgInput').value = '';
      
      // Send via data channel if available
      if (dataChannel && dataChannel.readyState === 'open') {
        try {
          dataChannel.send(JSON.stringify({
            type: 'chat',
            text: text,
            from: state.token
          }));
        } catch (e) {
          console.warn('Failed to send over data channel', e);
        }
      }
    });
    
    document.getElementById('msgInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('sendBtn').click();
      }
    });
    
    document.getElementById('simulateIncoming').addEventListener('click', () => {
      if (!window.currentChat) {
        showToast('Please select a contact first');
        return;
      }
      
      const responses = [
        "Hello! How are you doing today?",
        "This AugVT technology is amazing!",
        "I received your message. What's new?",
        "Thanks for reaching out. How can I help?",
        "I'm interested in learning more about AugVT."
      ];
      
      const randomResponse = responses[Math.floor(Math.random() * responses.length)];
      appendMessage(window.currentChat, randomResponse, false);
    });
    
    // WebRTC event listeners
    document.getElementById('createOffer').addEventListener('click', async () => {
      pc = await createPeer(true);
      dataChannel = pc.createDataChannel('augvt-data');
      setupDataChannel();
      
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      
      const offerText = JSON.stringify(pc.localDescription);
      document.getElementById('offer').value = offerText;
      
      // Try to copy to clipboard
      try {
        await navigator.clipboard.writeText(offerText);
        showToast('Offer created and copied to clipboard');
      } catch (e) {
        showToast('Offer created - please copy manually');
      }
    });
    
    document.getElementById('createAnswer').addEventListener('click', async () => {
      const text = document.getElementById('answer').value.trim();
      if (!text) {
        showToast('Please paste an offer first');
        return;
      }
      
      const offer = JSON.parse(text);
      pc = await createPeer(false);
      await pc.setRemoteDescription(offer);
      
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      
      const answerText = JSON.stringify(pc.localDescription);
      document.getElementById('answer').value = answerText;
      
      // Try to copy to clipboard
      try {
        await navigator.clipboard.writeText(answerText);
        showToast('Answer created and copied to clipboard');
      } catch (e) {
        showToast('Answer created - please copy manually');
      }
    });
    
    document.getElementById('pasteAnswer').addEventListener('click', async () => {
      const text = document.getElementById('answer').value.trim();
      if (!text) {
        showToast('Please paste an answer first');
        return;
      }
      
      const answer = JSON.parse(text);
      if (!pc) {
        showToast('Please create an offer first');
        return;
      }
      
      await pc.setRemoteDescription(answer);
      showToast('Answer applied - connection in progress');
    });
    
    document.getElementById('copyOffer').addEventListener('click', async () => {
      const offerText = document.getElementById('offer').value;
      if (!offerText) {
        showToast('No offer to copy');
        return;
      }
      
      try {
        await navigator.clipboard.writeText(offerText);
        showToast('Offer copied to clipboard');
      } catch (e) {
        showToast('Copy failed - please copy manually');
      }
    });
    
    document.getElementById('startCall').addEventListener('click', async () => {
      if (!pc) {
        showToast('Please establish a WebRTC connection first');
        return;
      }
      
      if (localStream) {
        localStream.getAudioTracks().forEach(track => track.enabled = true);
        showToast('Call started');
        document.getElementById('endCall').disabled = false;
      } else {
        showToast('No microphone available');
      }
    });
    
    document.getElementById('endCall').addEventListener('click', () => {
      if (pc) {
        pc.getSenders().forEach(sender => {
          try {
            if (sender.track) sender.track.stop();
          } catch (e) {}
        });
        pc.close();
        pc = null;
        dataChannel = null;
        
        connectionStatusEl.textContent = 'WebRTC: Not connected â€¢ Data channel: Closed';
        connectionStatusEl.className = 'connection-status status-disconnected';
        globalStatusEl.textContent = 'Status: Disconnected';
        globalStatusEl.className = 'connection-status status-disconnected';
        
        document.getElementById('endCall').disabled = true;
        showToast('Call ended');
      }
    });
    
    // File drop functionality
    fileDropArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileDropArea.classList.add('active');
    });
    
    fileDropArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      fileDropArea.classList.remove('active');
    });
    
    fileDropArea.addEventListener('drop', async (e) => {
      e.preventDefault();
      fileDropArea.classList.remove('active');
      
      const file = e.dataTransfer.files[0];
      if (!file) return;
      
      if (dataChannel && dataChannel.readyState === 'open') {
        try {
          dataChannel.send(JSON.stringify({
            type: 'file',
            name: file.name,
            size: file.size
          }));
          appendMessage(window.currentChat || 'peer', `Sent file: ${file.name}`, true);
        } catch (e) {
          console.warn('Failed to send file metadata', e);
        }
      } else {
        appendMessage(window.currentChat || 'peer', `Saved file locally: ${file.name}`, true);
      }
    });
    
    // Preset contact click handlers
    document.querySelectorAll('.preset-contact').forEach(contactEl => {
      contactEl.addEventListener('click', () => {
        const name = contactEl.getAttribute('data-name');
        const token = contactEl.getAttribute('data-token');
        const id = name.toLowerCase().replace(' ', '-');
        
        // Find or create the contact
        let contact = state.contacts.find(c => c.id === id);
        if (!contact) {
          contact = {
            id,
            name,
            token,
            avatar: contactEl.querySelector('.contact-avatar').textContent
          };
          state.contacts.push(contact);
          saveState();
        }
        
        openChat(id);
        
        // Highlight the contact in the list
        document.querySelectorAll('.contact').forEach(el => {
          el.classList.remove('active');
          if (el.querySelector('.contact-name').textContent === name) {
            el.classList.add('active');
          }
        });
      });
    });
    
    // Initialize
    renderContacts();
    
    // Simulate Donald Trump sending a message after a delay
    setTimeout(() => {
      if (state.contacts.find(c => c.id === 'donald-trump')) {
        state.chats['donald-trump'] = state.chats['donald-trump'] || [];
        state.chats['donald-trump'].push({
          text: "This AugVT technology is fantastic! The best technology, really tremendous!",
          out: false,
          time: Date.now() - 60000 // 1 minute ago
        });
        saveState();
      }
    }, 2000);
  </script>
</body>
</html>
